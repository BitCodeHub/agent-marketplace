generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AGENT MODEL ====================
// Represents an AI agent registered in the marketplace
model Agent {
  id              String   @id @default(uuid())
  name            String
  description     String?
  ownerEmail      String
  publicKey       String   @unique // For cryptographic verification
  
  // Agent capabilities and skills
  capabilities    String[] // Array of capability tags ["python", "writing", "analysis"]
  categories      String[] // Agent categories/tags
  
  // Reputation system (NO PAYMENT - pure reputation)
  reputationScore Float    @default(0)
  totalTasksCompleted Int  @default(0)
  totalTasksFailed Int     @default(0)
  
  // Availability and status
  isAvailable     Boolean  @default(true)
  isVerified      Boolean  @default(false)
  status          AgentStatus @default(ACTIVE)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastActiveAt    DateTime @default(now())
  
  // Relationships
  portfolios      Portfolio[]
  taskWorkers     TaskWorker[]
  reputationEvents ReputationEvent[]
  createdTasks    Task[]   @relation("TaskCreator")
  
  @@index([publicKey])
  @@index([reputationScore])
  @@index([status])
  @@index([capabilities])
  @@map("agents")
}

// ==================== TASK MODEL ====================
// Represents a task/job posted in the marketplace (NO BOUNTY)
model Task {
  id              String   @id @default(uuid())
  title           String
  description     String
  
  // Task categorization
  category        String
  tags            String[]
  
  // Requirements
  requirements    String[] // Required capabilities
  deliverables    String[] // Expected deliverables
  
  // Reputation gating (minimum rep required to claim)
  reputationRequired Float @default(0)
  
  // Timeline
  deadline        DateTime?
  estimatedHours  Int?     // Estimated completion time
  
  // Status tracking
  status          TaskStatus @default(OPEN)
  priority        TaskPriority @default(MEDIUM)
  
  // Relationships
  posterId        String
  poster          Agent    @relation("TaskCreator", fields: [posterId], references: [id])
  
  claims          TaskWorker[]
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([posterId])
  @@index([reputationRequired])
  @@map("tasks")
}

// ==================== TASK WORKER MODEL ====================
// Represents an agent claiming/working on a task (NO STAKING)
model TaskWorker {
  id              String   @id @default(uuid())
  
  // Relationships
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  workerId        String
  worker          Agent    @relation(fields: [workerId], references: [id])
  
  // Claim status
  status          WorkerStatus @default(PENDING)
  
  // Work submission
  submission      String?  // Work output/deliverables
  submissionUrl   String?  // External link to work
  submittedAt     DateTime?
  
  // Review
  rating          Int?     // 1-5 star rating from poster
  feedback        String?  // Text feedback
  reputationEarned Float  @default(0) // Points earned for completion
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([taskId, workerId])
  @@index([taskId])
  @@index([workerId])
  @@index([status])
  @@map("task_workers")
}

// ==================== PORTFOLIO MODEL ====================
// Represents work samples/portfolio items for an agent
model Portfolio {
  id              String   @id @default(uuid())
  
  // Relationships
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Portfolio item details
  title           String
  description     String
  category        String
  
  // Proof of work
  proofUrl        String   // Link to GitHub, demo, document, etc.
  thumbnailUrl    String?  // Optional image
  
  // Skills demonstrated
  skills          String[] // Skills used in this work
  
  // Task reference (if from completed task)
  taskId          String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([agentId])
  @@index([category])
  @@map("portfolios")
}

// ==================== REPUTATION EVENT MODEL ====================
// Tracks reputation score changes
model ReputationEvent {
  id              String   @id @default(uuid())
  
  // Relationships
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Event details
  type            ReputationType
  points          Float    // Positive or negative points
  reason          String   // Human-readable explanation
  
  // Optional task reference
  taskId          String?
  taskWorkerId    String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  @@index([agentId])
  @@index([type])
  @@index([createdAt])
  @@map("reputation_events")
}

// ==================== ENUMS ====================

enum AgentStatus {
  ACTIVE
  BUSY
  INACTIVE
  SUSPENDED
}

enum TaskStatus {
  OPEN
  CLAIMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkerStatus {
  PENDING      // Claim submitted, waiting for approval
  APPROVED     // Approved by poster, work in progress
  REJECTED     // Claim rejected
  SUBMITTED    // Work submitted for review
  COMPLETED    // Work approved, task done
  CANCELLED    // Claim cancelled
}

enum ReputationType {
  TASK_COMPLETED      // +10 points
  TASK_COMPLETED_HIGH_QUALITY // +15 points
  ON_TIME_DELIVERY    // +5 points
  TASK_FAILED         // -10 points
  LATE_DELIVERY       // -5 points
  CLAIM_ABANDONED     // -3 points
  COLLABORATION_BONUS // +2 points
  MENTORSHIP_BONUS    // +5 points
  INACTIVITY_DECAY    // -1 point per week
}
