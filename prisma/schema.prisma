generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm(schema: "public"), btree_gin(schema: "public")]
}

// ==================== AGENT MODEL ====================
// Represents an AI agent registered in the marketplace
model Agent {
  id              String   @id @default(uuid())
  name            String   @db.VarChar(100)
  description     String?  @db.VarChar(2000)
  ownerEmail      String   @db.VarChar(255)
  publicKey       String   @unique @db.VarChar(255) // For cryptographic verification
  
  // Agent capabilities and skills
  capabilities    String[] // Array of capability tags ["python", "writing", "analysis"]
  categories      String[] // Agent categories/tags
  
  // Reputation system (NO PAYMENT - pure reputation)
  reputationScore Float    @default(0)
  totalTasksCompleted Int  @default(0)
  totalTasksFailed Int     @default(0)
  
  // Availability and status
  isAvailable     Boolean  @default(true)
  isVerified      Boolean  @default(false)
  status          AgentStatus @default(ACTIVE)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastActiveAt    DateTime @default(now())
  
  // Relationships
  portfolios      Portfolio[]
  taskWorkers     TaskWorker[]
  reputationEvents ReputationEvent[]
  createdTasks    Task[]   @relation("TaskCreator")
  
  // ==================== INDEXES ====================
  @@index([publicKey])
  @@index([reputationScore])
  @@index([status])
  @@index([capabilities], type: Gin)
  @@index([createdAt])
  @@index([status, reputationScore])
  @@index([isAvailable, status])
  @@index([reputationScore, totalTasksCompleted])
  @@index([createdAt, status])
  
  // ==================== CONSTRAINTS ====================
  @@unique([name, ownerEmail], name: "Agent_name_owner_unique")
  
  // NOTE: PostgreSQL check constraints can be added via migration:
  // ALTER TABLE agents ADD CONSTRAINT reputation_score_bounds 
  //   CHECK (reputation_score >= -1000 AND reputation_score <= 10000);
  // ALTER TABLE agents ADD CONSTRAINT tasks_completed_positive CHECK (total_tasks_completed >= 0);
  // ALTER TABLE agents ADD CONSTRAINT tasks_failed_positive CHECK (total_tasks_failed >= 0);
  
  @@map("agents")
}

// ==================== TASK MODEL ====================
// Represents a task/job posted in the marketplace (NO BOUNTY)
model Task {
  id              String   @id @default(uuid())
  title           String   @db.VarChar(200)
  description     String   @db.VarChar(5000)
  
  // Task categorization
  category        String   @db.VarChar(50)
  tags            String[]
  
  // Requirements
  requirements    String[] // Required capabilities
  deliverables    String[] // Expected deliverables
  
  // Reputation gating (minimum rep required to claim)
  reputationRequired Float @default(0)
  
  // Timeline
  deadline        DateTime?
  estimatedHours  Int?     // Estimated completion time
  
  // Status tracking
  status          TaskStatus @default(OPEN)
  priority        TaskPriority @default(MEDIUM)
  
  // Relationships
  posterId        String
  poster          Agent    @relation("TaskCreator", fields: [posterId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  claims          TaskWorker[]
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // ==================== INDEXES ====================
  @@index([status])
  @@index([posterId])
  @@index([reputationRequired])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([status, priority])
  @@index([posterId, status])
  @@index([category, status])
  @@index([deadline, status])
  @@index([reputationRequired, status])
  @@index([status, createdAt, priority])
  
  // ==================== CONSTRAINTS ====================
  // NOTE: PostgreSQL check constraints can be added via migration:
  // ALTER TABLE tasks ADD CONSTRAINT reputation_required_bounds 
  //   CHECK (reputation_required >= 0 AND reputation_required <= 10000);
  // ALTER TABLE tasks ADD CONSTRAINT estimated_hours_positive 
  //   CHECK (estimated_hours IS NULL OR estimated_hours >= 0);
  
  @@map("tasks")
}

// ==================== TASK WORKER MODEL ====================
// Represents an agent claiming/working on a task (NO STAKING)
model TaskWorker {
  id              String   @id @default(uuid())
  
  // Relationships
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  workerId        String
  worker          Agent    @relation(fields: [workerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  // Claim status
  status          WorkerStatus @default(PENDING)
  
  // Work submission
  submission      String?  @db.VarChar(10000) // Work output/deliverables
  submissionUrl   String?  @db.VarChar(500)   // External link to work
  submittedAt     DateTime?
  
  // Review
  rating          Int?     // 1-5 star rating from poster
  feedback        String?  @db.VarChar(2000)  // Text feedback
  reputationEarned Float  @default(0) // Points earned for completion
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // ==================== INDEXES ====================
  @@unique([taskId, workerId])
  @@index([taskId])
  @@index([workerId])
  @@index([status])
  @@index([createdAt])
  @@index([taskId, status])
  @@index([workerId, status])
  @@index([status, createdAt])
  @@index([taskId, workerId, status])
  @@index([workerId, createdAt, status])
  
  // ==================== CONSTRAINTS ====================
  // NOTE: PostgreSQL check constraints can be added via migration:
  // ALTER TABLE task_workers ADD CONSTRAINT rating_bounds 
  //   CHECK (rating IS NULL OR (rating >= 1 AND rating <= 5));
  // ALTER TABLE task_workers ADD CONSTRAINT reputation_earned_bounds 
  //   CHECK (reputation_earned >= -1000 AND reputation_earned <= 1000);
  
  @@map("task_workers")
}

// ==================== PORTFOLIO MODEL ====================
// Represents work samples/portfolio items for an agent
model Portfolio {
  id              String   @id @default(uuid())
  
  // Relationships
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  // Portfolio item details
  title           String   @db.VarChar(200)
  description     String   @db.VarChar(2000)
  category        String   @db.VarChar(50)
  
  // Proof of work
  proofUrl        String   @db.VarChar(500) // Link to GitHub, demo, document, etc.
  thumbnailUrl    String?  @db.VarChar(500) // Optional image
  
  // Skills demonstrated
  skills          String[] // Skills used in this work
  
  // Task reference (if from completed task)
  taskId          String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // ==================== INDEXES ====================
  @@index([agentId])
  @@index([category])
  @@index([createdAt])
  @@index([agentId, createdAt])
  @@index([category, createdAt])
  
  // ==================== CONSTRAINTS ====================
  @@unique([agentId, title, proofUrl], name: "Portfolio_agent_title_url_unique")
  
  @@map("portfolios")
}

// ==================== REPUTATION EVENT MODEL ====================
// Tracks reputation score changes
model ReputationEvent {
  id              String   @id @default(uuid())
  
  // Relationships
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  // Event details
  type            ReputationType
  points          Float    // Positive or negative points
  reason          String   @db.VarChar(500) // Human-readable explanation
  
  // Optional task reference
  taskId          String?
  taskWorkerId    String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  
  // ==================== INDEXES ====================
  @@index([agentId])
  @@index([type])
  @@index([createdAt])
  @@index([agentId, createdAt])
  @@index([agentId, type])
  @@index([type, createdAt])
  @@index([agentId, type, createdAt])
  @@index([createdAt, agentId])
  @@index([taskId])
  
  // ==================== CONSTRAINTS ====================
  // NOTE: PostgreSQL check constraints can be added via migration:
  // ALTER TABLE reputation_events ADD CONSTRAINT points_bounds 
  //   CHECK (points >= -1000 AND points <= 1000);
  // ALTER TABLE reputation_events ADD CONSTRAINT reason_not_empty CHECK (char_length(reason) > 0);
  
  @@map("reputation_events")
}

// ==================== ENUMS ====================

enum AgentStatus {
  ACTIVE
  BUSY
  INACTIVE
  SUSPENDED
}

enum TaskStatus {
  OPEN
  CLAIMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkerStatus {
  PENDING      // Claim submitted, waiting for approval
  APPROVED     // Approved by poster, work in progress
  REJECTED     // Claim rejected
  SUBMITTED    // Work submitted for review
  COMPLETED    // Work approved, task done
  CANCELLED    // Claim cancelled
}

enum ReputationType {
  TASK_COMPLETED      // +10 points
  TASK_COMPLETED_HIGH_QUALITY // +15 points
  ON_TIME_DELIVERY    // +5 points
  TASK_FAILED         // -10 points
  LATE_DELIVERY       // -5 points
  CLAIM_ABANDONED     // -3 points
  COLLABORATION_BONUS // +2 points
  MENTORSHIP_BONUS    // +5 points
  INACTIVITY_DECAY    // -1 point per week
}
